# ========================================
# ğŸ’» ë‹¤ì´ì•„/ì˜¤í† í•«í‚¤ ìƒíƒœ ìˆ˜ì‹  ì„œë²„
# ğŸ“¦ íŒŒì¼ëª…: server.py
# ğŸ“… ë²„ì „: v1.5.0 (2025-06-30)
# ğŸ‘¨â€ğŸ’» ê°œì„ ì‚¬í•­:
#   - í´ë¼ì´ì–¸íŠ¸ì—ê²Œ AHK ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥ ì¶”ê°€
#   - ìˆ˜ì‹ /ì†¡ì‹  ë¡œê·¸ ì •ì œ ë° ì˜¤ë¥˜ ë¡œê¹… ê°•í™”
# ========================================

import sys, socket, threading, json, datetime, time
import os, traceback


# ì‹¤í–‰ ìœ„ì¹˜ ê¸°ì¤€ ë””ë ‰í„°ë¦¬ (EXE ëŒ€ì‘ í¬í•¨)
BASE_DIR = os.path.dirname(sys.executable if getattr(sys, 'frozen', False) else os.path.abspath(__file__))

# ê¸°ë³¸ ì„¤ì •ê°’
DEFAULT_CONFIG = {
    "server_ip": "0.0.0.0",
    "server_port": 5050,
    "log_path": os.path.join(BASE_DIR, "server_log.txt"),
    "debug_log_path": os.path.join(BASE_DIR, "client_debug.log"),
    "report_interval_sec": 58
}

# í˜„ì¬ ì‹œê° ë¬¸ìì—´ ë°˜í™˜
def now():
    return datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

# ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
def load_config():
    try:
        with open(os.path.join(BASE_DIR, "settings.json"), "r", encoding="utf-8") as f:
            user = json.load(f)
            return {**DEFAULT_CONFIG, **user}
    except:
        return DEFAULT_CONFIG

# ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
def log(msg, file):
    text = f"[{now()}] {msg}"
    print(text)
    try:
        with open(file, "a", encoding="utf-8") as f:
            f.write(text + "\n")
    except:
        pass  # ë¡œê·¸ íŒŒì¼ ì ‘ê·¼ ë¬¸ì œ ìˆì„ ì‹œ ë¬´ì‹œ

# AHK ìƒì¡´ ê¸°ë¡ ì €ì¥ì†Œ
ahk_map = {}  # {name: last_report_time}
ahk_lock = threading.Lock()

# ê°ì‹œ ë£¨í”„: ì¼ì • ì‹œê°„ ì´ìƒ ìˆ˜ì‹  ì—†ìœ¼ë©´ ê²½ê³  ì¶œë ¥
def watch_ahk(alert_sec, log_path):
    while True:
        now_ts = time.time()
        with ahk_lock:
            for name, last in list(ahk_map.items()):
                if now_ts - last > alert_sec:
                    mins = int((now_ts - last) // 60)
                    log(f"â—AHK ìˆ˜ì‹  ì¤‘ë‹¨ â†’ {name} ({mins}ë¶„ ì´ìƒ)", log_path)
        time.sleep(60)

# í´ë¼ì´ì–¸íŠ¸ì— TCPë¡œ ë©”ì‹œì§€ ì „ì†¡ (â†’ í´ë¼ê°€ AHK ì‹¤í–‰)
def send_to_client(client_ip, message, log_path):
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
            sock.connect((client_ip, 6000))
            sock.sendall(message.encode("utf-8"))
        log(f"ğŸ“¤ í´ë¼ë¡œ ëª…ë ¹ ì „ì†¡ â†’ {client_ip} | ë‚´ìš©: {message}", log_path)
    except Exception as e:
        log(f"âš ï¸ í´ë¼ ì „ì†¡ ì‹¤íŒ¨ â†’ {client_ip} | ì˜¤ë¥˜: {e}", log_path)

# ìˆ˜ì‹  ì²˜ë¦¬ í•¨ìˆ˜
def handle_client(conn, addr, log_path):
    try:
        raw = conn.recv(2048)
        if not raw:
            log(f"âš ï¸ ìˆ˜ì‹  ì‹¤íŒ¨: ë¹ˆ ë°ì´í„° (IP: {addr[0]})", log_path)
            return

        try:
            payload = json.loads(raw.decode("utf-8"))
        except Exception as e:
            log(f"âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨: {e}", log_path)
            return

        # ğŸ”¹ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚´ì˜¨ í•„ë“œë“¤ íŒŒì‹±
        ip          = payload.get("ip", addr[0])
        name        = payload.get("name", "unknown")
        game        = payload.get("game", "?")
        game_server = payload.get("game_server", "?")
        dia         = payload.get("dia", "?")
        msg         = payload.get("msg", "?")

        # ğŸ”¹ ìƒì¡´ ê°±ì‹ 
        with ahk_lock:
            ahk_map[name] = time.time()

        # ğŸ”¸ ì˜ˆì˜ê²Œ ì¶œë ¥
        log_line = f"ìˆ˜ì‹  â†’ {ip} | {name} | {game_server} | ê²Œì„: {game} | ë‹¤ì´ì•„: {dia} | ë©”ì‹œì§€: {msg}"
        log(log_line, log_path)

    except Exception as e:
        log(f"âš ï¸ ìˆ˜ì‹  ì²˜ë¦¬ ì‹¤íŒ¨: {e}\n{traceback.format_exc()}", log_path)
    finally:
        conn.close()

# ì„œë²„ ë©”ì¸ ë£¨í”„
def start_server():
    config = load_config()
    host = config["server_ip"]
    port = config["server_port"]
    log_path = config["log_path"]
    alert_sec = config.get("report_interval_sec", 58) * 2

    log(f"âœ… ì„œë²„ í¬íŠ¸ {port} ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...", log_path)

    threading.Thread(target=watch_ahk, args=(alert_sec, log_path), daemon=True).start()

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    try:
        s.bind((host, port))
        s.listen(5)
    except Exception as e:
        log(f"âš ï¸ ì„œë²„ ë°”ì¸ë”© ì‹¤íŒ¨: {e}", log_path)
        return

    while True:
        try:
            conn, addr = s.accept()
            threading.Thread(target=handle_client, args=(conn, addr, log_path), daemon=True).start()
        except Exception as e:
            log(f"âš ï¸ í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì‹  ì˜¤ë¥˜: {e}", log_path)

# ì‹œì‘ í¬ì¸íŠ¸
if __name__ == "__main__":
    start_server()