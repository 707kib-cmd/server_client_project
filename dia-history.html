<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <!-- ğŸ¯ ëª¨ë“ˆí™”ëœ JavaScript íŒŒì¼ë“¤ -->
    <script src="js/core/state.js"></script>
    <script src="js/core/utils.js"></script>
    <script src="js/core/api.js"></script>
    <script src="js/dashboard/cards.js"></script>
    <script src="js/charts/dia-history.js"></script>
    <script src="js/main.js"></script>

    <link rel="stylesheet" href="css/dia-history.css">
    <title>ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡</title>
</head>
<body>

<div id="serverSummary"
     style="position:absolute; top:12px; left:12px;
              background:rgba(255,255,255,0.8);
              padding:4px 8px; border-radius:4px;
              font-weight:bold; z-index:10;">
    ë¡œë”© ì¤‘...
</div>


<h1 style="margin-top: 20px; margin-bottom: 10px;">ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡</h1>
<div class="top-bar">
    <div id="serverSummary"></div>
    <div style="position: relative;">
        <input id="searchClient" placeholder="ğŸ” í´ë¼ì´ì–¸íŠ¸ ê²€ìƒ‰..." oninput="filterClientName(window)"/>
        <div id="suggestList"></div>
    </div>
    <div id="serverFilter"></div>
</div>

<div class="layout">
    <div class="history-column">
        <div id="diaHistoryContent">
            <div class="history-text">â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

    </div>
    <div class="chart-column">
        <div>
            <h2 style="text-align: center;">ğŸ“Š TOTAL ì¶”ì„¸ ê·¸ë˜í”„</h2>
            <div class="chart-toolbar">
                <button onclick="renderTotalTrendChart(3, window)">3ì¼</button>
                <button onclick="renderTotalTrendChart(7, window)">7ì¼</button>
                <button onclick="renderTotalTrendChart(30, window)">30ì¼</button>
                <button onclick="renderTotalTrendChart(999, window)">ì „ì²´</button>
            </div>
            <canvas id="totalTrendChart" width="960" height="300"></canvas>
        </div>

        <div>
            <h2 style="text-align: center;">ğŸ“Š ì„œë²„ë³„ ì¶”ì„¸ì„ </h2>
            <div class="chart-toolbar">
                <button onclick="renderServerTrendChart(3, window)">3ì¼</button>
                <button onclick="renderServerTrendChart(7, window)">7ì¼</button>
                <button onclick="renderServerTrendChart(30, window)">30ì¼</button>
                <button onclick="renderServerTrendChart(999, window)">ì „ì²´</button>
            </div>
            <canvas id="serverTrendChart" width="960" height="300"></canvas>
        </div>
    </div>
</div>

<!-- âœ… ì˜ì¡´ JSë“¤ -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="dashboard.js"></script>
<script>
    window.addEventListener("DOMContentLoaded", () => {
        // ë Œë” í•¨ìˆ˜ ì¤€ë¹„
        win = window;

        win.renderDiaHistoryContent = renderDiaHistoryContent;
        win.renderTotalTrendChart = renderTotalTrendChart;
        win.renderServerTrendChart = renderServerTrendChart;

        // ì´ˆê¸° ë Œë”ë§ í˜¸ì¶œ
        renderDiaHistoryContent(win);
        renderTotalTrendChart(7, win);
        renderServerTrendChart(7, win);

        // ğŸ” ì„œë²„ í•„í„° ë²„íŠ¼ êµ¬ì„±
        const raw = localStorage.getItem("dailyDiaStats");
        const data = JSON.parse(raw || "{}");
        const serverSet = new Set();
        Object.values(data).forEach(day => {
            Object.keys(day).forEach(name => {
                if (!["TOTAL", "SERVER_SUM", "COUNT_BY_SERVER"].includes(name)) {
                    const server = name.split("-")[0];
                    serverSet.add(server);
                }
            });
        });

        const serverDiv = document.getElementById("serverFilter");
        const allBtn = document.createElement("button");
        allBtn.textContent = "ì „ì²´";
        allBtn.onclick = () => renderDiaHistoryContent(win, null);
        serverDiv.appendChild(allBtn);

        Array.from(serverSet).sort().forEach(server => {
            const btn = document.createElement("button");
            btn.textContent = server;
            btn.onclick = () => renderDiaHistoryContent(win, server);
            serverDiv.appendChild(btn);
        });
    });

    // ğŸ” ìë™ ì œì•ˆ ê²€ìƒ‰ ê¸°ëŠ¥ ì •ì˜ (ê¸°ì¡´ íŒì—… ë°©ì‹ ë™ì¼)
    function filterClientName(win = window) {
        const inputEl = win.document.getElementById("searchClient");
        const suggestDiv = win.document.getElementById("suggestList");
        if (!inputEl || !suggestDiv) return;
        const input = inputEl.value.trim().toLowerCase();
        const raw = localStorage.getItem("dailyDiaStats");
        if (!raw) return;

        const dataMap = JSON.parse(raw);
        const allNames = new Set();

        Object.values(dataMap).forEach(day => {
            Object.keys(day).forEach(name => {
                if (!["TOTAL", "SERVER_SUM", "COUNT_BY_SERVER"].includes(name)) {
                    allNames.add(name);
                }
            });
        });

        const matched = Array.from(allNames).filter(name =>
            name.toLowerCase().includes(input)
        ).slice(0, 10);

        suggestDiv.innerHTML = "";
        let selectedIndex = -1;

        matched.forEach((name, i) => {
            const div = win.document.createElement("div");
            div.textContent = name;
            div.className = "suggest-item";
            div.onmouseover = () => updateHighlight(i);
            div.onmouseout = () => updateHighlight(-1);
            div.onclick = () => {
                inputEl.value = name;
                suggestDiv.style.display = "none";
                win.renderDiaHistoryContent(win, null, name);
            };
            suggestDiv.appendChild(div);
        });

        suggestDiv.style.display = matched.length ? "block" : "none";

        if (!inputEl._keyboardAttached) {
            inputEl.addEventListener("keydown", (e) => {
                const items = suggestDiv.querySelectorAll(".suggest-item");
                if (!items.length) return;

                if (e.key === "ArrowDown") {
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateHighlight(selectedIndex);
                    e.preventDefault();
                } else if (e.key === "ArrowUp") {
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateHighlight(selectedIndex);
                    e.preventDefault();
                } else if (e.key === "Enter") {
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        inputEl.value = items[selectedIndex].textContent;
                        suggestDiv.style.display = "none";
                        win.renderDiaHistoryContent(win, null, inputEl.value);
                        selectedIndex = -1;
                    }
                } else if (e.key === "Escape") {
                    suggestDiv.style.display = "none";
                    selectedIndex = -1;
                }
            });
            inputEl._keyboardAttached = true;
        }

        function updateHighlight(index) {
            const items = suggestDiv.querySelectorAll(".suggest-item");
            items.forEach((el, i) => {
                el.style.background = i === index ? "#ddd" : "";
            });
        }
    }
</script>

<!-- ì—¬ê¸°ì— ì°¨íŠ¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("â–¶ í˜ì´ì§€ ë¡œë“œ, ì°¨íŠ¸ ë Œë” ì‹œì‘");
        // 7ì¼ì¹˜ TOTALÂ·ì„œë²„ë³„ ì¶”ì„¸ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        renderTotalTrendChart(7, window);
        renderServerTrendChart(7, window);
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1) serverFilter, setServerFilter ì „ì—­ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        //    (cardboard ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ ìƒíƒœë¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        window.serverFilter = window.serverFilter || null;

        // 2) API í˜¸ì¶œ í›„ ìš”ì•½ í•¨ìˆ˜ ì‹¤í–‰
        fetch('/api/clients')
            .then(res => res.json())
            .then(data => updateServerSummary(data))
            .catch(err => console.error('âŒ server summary error', err));

        // 3) ê¸°ì¡´ ì°¨íŠ¸ ë Œë”ë§ë„ ê·¸ëŒ€ë¡œ
        renderTotalTrendChart(7, window);
        renderServerTrendChart(7, window);
    });
</script>

</body>
</html>
