
// âœ… ìƒíƒœê°’
let condensed = false;
let serverFilter = null;

// âœ… ìœ í‹¸ í•¨ìˆ˜
    function trimTimestamp(ts) {
      return ts.replace(/^20\d\d-/, '');
    }

	function getThresholdMs() {
	  const el = document.getElementById("threshold");
	  if (!el) return 300000; // ê¸°ë³¸ê°’: 5ë¶„

	  return parseInt(el.value) * 60 * 1000;
	}

    function setServerFilter(name) {
      serverFilter = name === '__ALL__' ? null : name;
      fetchClients();
    }

// âœ… UI ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function toggleCondensed() {
      condensed = !condensed;
      document.getElementById("toggle-btn").textContent = condensed ? "ì „ì²´ ëª¨ë“œ" : "ê°„ê²° ëª¨ë“œ";
      fetchClients();
	}



// âœ… ì„œë²„ ìš”ì•½ ì •ë³´ ì¶œë ¥
function updateServerSummary(data) {
  const summary = {};
  data.forEach(c => {
    if (!c.server) return;
    summary[c.server] = (summary[c.server] || 0) + Number(c.dia || 0);
  });

  const serverLinks = Object.entries(summary).map(([server, total]) => {
    const active = server === serverFilter ? 'active' : '';
    return `<span class="${active}" onclick="setServerFilter('${server}')">${server}: ${total}</span>`;
  }).join(' | ');

  const allLink = `<span class="${!serverFilter ? 'active' : ''}" onclick="setServerFilter('__ALL__')">ì „ì²´ ë³´ê¸°</span>`;

  const historyBtn = `<button onclick="showDiaHistory()" style="font-size: 0.8em; padding: 2px 6px; margin-left: 6px;">ğŸ“… ì¶”ì </button>`;

  const html = `ë‹¤ì´ì•„ í•©ì‚° â†’ ${serverLinks} | ${allLink} ${historyBtn}`;

  document.getElementById("serverSummary").innerHTML = html;
}

    function getClientOrder() {
      return JSON.parse(localStorage.getItem("clientOrder") || "[]");
    }

    function setClientOrder(order) {
      localStorage.setItem("clientOrder", JSON.stringify(order));
    }

function fetchClients() {
  const threshold = getThresholdMs();
  const now = Date.now();
  const clientOrder = getClientOrder();

  fetch("/api/clients")
    .then(res => res.json())
    .then(data => {
      updateServerSummary(data);
      const grid = document.getElementById("dashboard");

      const clientMap = {};
      data.forEach(c => clientMap[c.name] = c);

      const names = clientOrder.length > 0 ? clientOrder : data.map(c => c.name);

names.forEach(name => {
  const existing = grid.querySelector(`.card[data-name="${name}"]`);

  // âœ… ì´ë¯¸ ìˆëŠ” ì¹´ë“œë¼ë©´ ëª¨ë“œ ì „í™˜ìš© ë‚´ìš© ì—…ë°ì´íŠ¸ë§Œ í•´ì£¼ê¸°
  if (existing) {
    const c = clientMap[name];
    if (c && !existing.classList.contains("empty")) {
      existing.innerHTML = condensed ? `
        <div class="name">${c.name}</div>
        <div class="info">
          ${c.server}<br>${c.dia}
        </div>
      ` : `
        <div class="name">${c.name}</div>
        <div class="info">
          ${c.ip}<br>
          ${c.game} (${c.server})<br>
          ${c.dia}<br>
          ${c.status.toUpperCase()}<br>
          ${trimTimestamp(c.last_report)}
        </div>
      `;
    }
    return; // âœ… ìƒˆë¡œ ìƒì„± ì•ˆ í•¨
  }

  const c = clientMap[name];
  const card = document.createElement("div");
  card.setAttribute("data-name", name);

  if (!c) {
    // ğŸ§Š ë¹ˆ ì¹´ë“œ ìë¦¬
    card.className = "card empty";
    card.setAttribute("data-server", "");
    card.innerHTML = `
      <div class="delete-btn" onclick="deleteCard('${name}')">ì‚­ì œ</div>
      <div class="name">ğŸ§Š ${name}</div>
      <div class="info">[ë¯¸ë™ì‘ ìë¦¬]</div>
    `;
  } else {
    const age = now - new Date(c.last_report).getTime();
    const barColor = age < threshold ? '#28a745' : '#dc3545';

    card.className = "card";
    card.setAttribute("data-server", c.server);
    card.style.borderLeftColor = barColor;

    card.innerHTML = condensed ? `
      <div class="name">${c.name}</div>
      <div class="info">
        ${c.server}<br>${c.dia}
      </div>
    ` : `
      <div class="name">${c.name}</div>
      <div class="info">
        ${c.ip}<br>
        ${c.game} (${c.server})<br>
        ${c.dia}<br>
        ${c.status.toUpperCase()}<br>
        ${trimTimestamp(c.last_report)}
      </div>
    `;
  }

  grid.appendChild(card);
});




      Sortable.create(grid, {
        animation: 150,
        swap: true,
        swapClass: "highlight",
        onEnd: () => {
          const newOrder = Array.from(grid.children).map(c => c.dataset.name);
          setClientOrder(newOrder);
        }
      });
	(function storeDailyDiaStats() {
	  const today = new Date().toISOString().slice(0, 10);
	  const dataMap = JSON.parse(localStorage.getItem("dailyDiaStats") || "{}");
	  if (dataMap[today]) return;

	  const stats = {
		TOTAL: 0,
		SERVER_SUM: {},
		COUNT_BY_SERVER: {}
	  };

	  names.forEach(name => {
		const c = clientMap[name];
		if (!c || !c.dia || !c.server) return;

		const dia = Number(c.dia);
		stats[name] = dia;
		stats.TOTAL += dia;
		stats.SERVER_SUM[c.server] = (stats.SERVER_SUM[c.server] || 0) + dia;
		stats.COUNT_BY_SERVER[c.server] = (stats.COUNT_BY_SERVER[c.server] || 0) + 1;
	  });

	  dataMap[today] = stats;
	  localStorage.setItem("dailyDiaStats", JSON.stringify(dataMap));
	})();

	// ğŸ‘‰ ê·¸ë¦¬ê³  ë‚˜ì„œ í•„í„° ì ìš©
	applyFilters();	
    });
}



function applyFilters() {
  const q = document.getElementById("searchInput")?.value.trim().toLowerCase();
  const minDia = parseInt(document.getElementById("minDiaInput")?.value || "0");
  const server = serverFilter;

  document.querySelectorAll(".card").forEach(card => {
    const isEmpty = card.classList.contains("empty");
    const serverName = card.dataset.server || "";
    const fullText = card.textContent.toLowerCase();

    const matchesText = !q || fullText.includes(q);
    const matchesServer = !server || isEmpty || serverName === server;

    let matchesDia = true;
    if (!isEmpty && minDia > 0) {
      const text = card.textContent;
      const nums = (text.match(/\d{1,3}(,\d{3})*|\d+/g) || []).map(s => parseInt(s.replace(/,/g, '')));
      const maxNum = Math.max(...nums.filter(n => !isNaN(n)));
      matchesDia = maxNum >= minDia;
    }

    const shouldDisplay = matchesText;

    card.classList.remove("ghost-card");

    if (shouldDisplay) {
      card.style.display = "";
      const shouldGhost = !matchesServer || !matchesDia;
      if (shouldGhost) card.classList.add("ghost-card");
    } else {
      card.style.display = "none";
    }
  });
}

	function addEmptyCard() {
	  let name = prompt("ë¹ˆ ì¹´ë“œ ì´ë¦„ ì…ë ¥")?.trim();
	  if (!name) name = `empty-${Date.now()}`;

	  const order = getClientOrder();
	  order.push(name);
	  setClientOrder(order);
	  fetchClients();
	}

    function deleteCard(name) {
      const grid = document.getElementById("dashboard");
      const card = grid.querySelector(`[data-name="${name}"]`);
      if (card) grid.removeChild(card);
      const newOrder = Array.from(grid.children).map(c => c.dataset.name);
      setClientOrder(newOrder);
    }

    fetchClients();
    setInterval(fetchClients, 5000);
	
	function showDiaHistory() {
	  const win = window.open("", "DiaHistoryWindow", "width=1920,height=1080,resizable=yes,scrollbars=yes");
	  if (!win) return alert("ğŸ“¦ íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”!");

	  win.document.title = "ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡";

	  win.document.head.innerHTML = `
		<style>
		  body {
			margin: 0;
			padding: 24px;
			background: #fff;
			font-family: 'Segoe UI', sans-serif;
			color: #333;
			max-width: 1080px;
			margin: auto;
		  }
		  h1 {
			font-size: 1.4em;
			margin-bottom: 6px;
		  }
		  .entry {
			display: flex;
			justify-content: space-between;
			padding: 6px 0;
			border-bottom: 1px dashed #eee;
			font-size: 0.9em;
		  }
		  .entry .label { font-weight: bold; }
		  .diff.up { color: #28a745; font-weight: bold; }
		  .diff.down { color: #dc3545; font-weight: bold; }
		  .diff.zero { color: #aaa; }
		</style>
	  `;

	  win.document.body.innerHTML = `
		<h1>ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡</h1>
		<div id="diaHistoryContent">
		  <p style="text-align: center; opacity: 0.6;">(ë°ì´í„° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...)</p>
		</div>
	  `;

	  // âœ¨ ë°ì´í„° ì¶œë ¥ì€ ì¶”í›„ ì—¬ê¸°ì— ì¶”ê°€ ê°€ëŠ¥!
	}	
	
function formatDiff(curr, prev) {
  const diff = curr - prev;
  if (diff > 0) return `<span class="diff up">ğŸ”º +${diff.toLocaleString()}</span>`;
  if (diff < 0) return `<span class="diff down">ğŸ”» ${diff.toLocaleString()}</span>`;
  return `<span class="diff zero">â€“</span>`;
}

function renderDiaHistoryContent(win) {
  const q = win.document.getElementById("searchClient")?.value.trim().toLowerCase();

  const raw = localStorage.getItem("dailyDiaStats");
  if (!raw) return;

  const dataMap = JSON.parse(raw);
  const dates = Object.keys(dataMap)
    .filter(d => {
      const diff = (new Date() - new Date(d)) / (1000 * 60 * 60 * 24);
      return diff <= 7;
    })
    .sort()
    .reverse();

  let html = "";

  for (let i = 0; i < dates.length; i++) {
    const date = dates[i];
    const curr = dataMap[date];
    const prev = dataMap[dates[i + 1]] || {};

    html += `<div class="section"><h2>${date}</h2>`;

    // âœ… ì „ì²´ í•©ì‚°
    const total = curr.TOTAL || 0;
    const totalPrev = prev.TOTAL || 0;
    html += `
      <div class="entry">
        <span class="label">ì „ì²´ í•©ì‚°</span>
        <span>${total.toLocaleString()} ${formatDiff(total, totalPrev)}</span>
      </div>
    `;

    // âœ… ì„œë²„ë³„ í•©ì‚°
    Object.entries(curr.SERVER_SUM || {}).forEach(([server, val]) => {
      const prevVal = (prev.SERVER_SUM || {})[server] || 0;
      const count = curr.COUNT_BY_SERVER?.[server] || 0;
      html += `
        <div class="entry">
          <span class="label">${server} (${count}ëª…)</span>
          <span>${val.toLocaleString()} ${formatDiff(val, prevVal)}</span>
        </div>
      `;
    });

    // âœ… í´ë¼ì´ì–¸íŠ¸ë³„ ë³€í™”ëŸ‰ ëª©ë¡
    Object.keys(curr).forEach(name => {
      if (["TOTAL", "SERVER_SUM", "COUNT_BY_SERVER"].includes(name)) return;
      if (q && !name.toLowerCase().includes(q)) return;

      const val = curr[name];
      const prevVal = prev?.[name] || 0;

      html += `
        <div class="entry">
          <span class="label">${name}</span>
          <span>${val.toLocaleString()} ${formatDiff(val, prevVal)}</span>
        </div>
      `;
    });

    // âœ… ì¦ê°ëŸ‰ ìƒìœ„ í´ë¼ TOP 3 í‘œì‹œ
    const clientDiffs = Object.keys(curr)
      .filter(name => !["TOTAL", "SERVER_SUM", "COUNT_BY_SERVER"].includes(name))
      .map(name => {
        const val = curr[name];
        const prevVal = prev?.[name] || 0;
        return { name, val, diff: val - prevVal };
      });

    const topGain = clientDiffs
      .filter(c => c.diff > 0)
      .sort((a, b) => b.diff - a.diff)
      .slice(0, 3);

    if (topGain.length > 0) {
      html += `<div class="entry"><span class="label">ğŸ“Œ ìƒìŠ¹ í´ë¼ TOP 3</span><span></span></div>`;
      topGain.forEach(c => {
        html += `
          <div class="entry">
            <span class="label">${c.name}</span>
            <span>${c.val.toLocaleString()} ${formatDiff(c.val, c.val - c.diff)}</span>
          </div>
        `;
      });
    }

    html += `</div>`; // ğŸ”š ì„¹ì…˜ ë‹«ê¸°
  }

  win.document.getElementById("diaHistoryContent").innerHTML = html;
}
function showDiaHistory() {
  const win = window.open("", "DiaHistoryWindow", "width=1920,height=1080,resizable=yes,scrollbars=yes");
  if (!win) return alert("ğŸ“¦ íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”!");

  win.document.title = "ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡";
  // ... head/style ì •ì˜
  win.document.body.innerHTML = `
  
<div class="toolbar">
  <button onclick="window.close()">ë‹«ê¸°</button>
  <button onclick="alert('ğŸ“ˆ ê·¸ë˜í”„ ì¤€ë¹„ ì¤‘!')">ğŸ“ˆ ê·¸ë˜í”„ ë³´ê¸°</button>
  <button onclick="clearDiaHistory()">ğŸ§¹ ê¸°ë¡ ì´ˆê¸°í™”</button>
  <button onclick="exportDiaHistory()">ğŸ“¤ CSV ë‚´ë³´ë‚´ê¸°</button>
</div>

<input id="searchClient" placeholder="ğŸ” í´ë¼ì´ì–¸íŠ¸ ê²€ìƒ‰..." 
  style="padding: 6px; margin: 12px 0; width: 240px; font-size: 0.9em;" 
  oninput="renderDiaHistoryContent(window)">
  
  
    <h1>ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡</h1>
    <div id="diaHistoryContent">â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  `;

  renderDiaHistoryContent(win); // ì—¬ê¸°ì„œ ì‹¤í–‰!
}	
	
Object.keys(curr).forEach(name => {
  // ì„œë²„ ê´€ë ¨ í‚¤ ì œì™¸
  if (["TOTAL", "SERVER_SUM", "COUNT_BY_SERVER"].includes(name)) return;
  const val = curr[name];
  const prevVal = prev?.[name] || 0;

  html += `
    <div class="entry">
      <span class="label">${name}</span>
      <span>${val.toLocaleString()} ${formatDiff(val, prevVal)}</span>
    </div>
  `;
});

win.document.body.innerHTML = `
  <div class="toolbar">
    <button onclick="window.close()">ë‹«ê¸°</button>
    <button onclick="alert('ğŸ“ˆ ê·¸ë˜í”„ ì¤€ë¹„ ì¤‘!')">ğŸ“ˆ ê·¸ë˜í”„ ë³´ê¸°</button>
    <button onclick="clearDiaHistory()">ğŸ§¹ ê¸°ë¡ ì´ˆê¸°í™”</button>
    <button onclick="exportDiaHistory()">ğŸ“¤ CSV ë‚´ë³´ë‚´ê¸°</button>
  </div>

  <h1>ğŸ“… ë‹¤ì´ì•„ ìˆ˜ëŸ‰ ì¶”ì  ê¸°ë¡</h1>
  <div id="diaHistoryContent">â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
`;

function clearDiaHistory() {
  if (confirm("ğŸ“¦ ëª¨ë“  ì¶”ì  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) {
    localStorage.removeItem("dailyDiaStats");
    alert("ğŸ§¹ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
    location.reload();
  }
}

function exportDiaHistory() {
  const raw = localStorage.getItem("dailyDiaStats");
  if (!raw) return alert("ğŸ“¦ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!");

  const dataMap = JSON.parse(raw);
  const rows = [["ë‚ ì§œ", "í´ë¼ì´ì–¸íŠ¸", "ë‹¤ì´ì•„"]];

  Object.entries(dataMap).forEach(([date, stats]) => {
    Object.keys(stats).forEach(name => {
      if (["TOTAL", "SERVER_SUM", "COUNT_BY_SERVER"].includes(name)) return;
      rows.push([date, name, stats[name]]);
    });
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "dia-history.csv";
  a.click();
  URL.revokeObjectURL(url);
}


